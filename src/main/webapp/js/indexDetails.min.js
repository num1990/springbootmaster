
/* global $, window */
$(document).ready(function(){

});

$(function () {

    uploadMultiFiles("notificationFile", "notificationImageId", "105014"); // 匹配意见告知书
    uploadMultiFiles("higherFile", "hiddenFile_higherImageId", "105015"); // 较高风险警示书
    uploadMultiFiles("notifyMarkFile", "notifyMarkImageId", "105017"); // 风险告知备案文件

    $("[id^=expendableFundImage]").each(function (i) {
        var $this = $(this);//input[type^='radio']
        var divId = $this.attr("id");
        var hiddenId = $this.find("input[type='hidden']").attr("id");

        uploadMultiFiles(divId, hiddenId, "105030"); // 期权产品匹配-可用资金证明材料
    });

});

function uploadSingleFile(divId, imageId, fileTypeCode){
    uploadFile(divId, imageId, fileTypeCode, 1);
}

function uploadMultiFiles(divId, imageId, fileTypeCode){
    uploadFile(divId, imageId, fileTypeCode, 10);
}

function uploadFile(divId, imageId, fileTypeCode, maxNumberOfFiles){
    // Load existing files:
    $('#'+divId).addClass('fileupload-processing');

    $('#'+divId).fileupload({
        maxFileSize: 2000000000, //2G
        url: $('#fileUploadUrl').val(), //TODO ADD FILE TYPE
        maxNumberOfFiles: maxNumberOfFiles,
        dropZone: $(this),
        submit: function (e, data) {
            data.formData = {
                customerNumber: $('#customerNumber').val(), //submit时来获取这些值
                identityType: $('#identityType').val(),
                identityNumber: $('#identityNumber').val(),
                investorSuitabilityId: $('#investorSuitabilityId').val(),
                businessRootId: $('#matchUpRootId').val(),
                name: $('#fullName').val(),
                businessRootType: 'MATCH_UP',
                businessType: "SUITABILITY", //固定值
                imageTypeCode: fileTypeCode
            };

            // if (!validateForm()) { //validate form
            //     data.context.find('button').prop('disabled', false);
            //     $(this).find('.error').text("请先输入必填项");
            //     return false;
            // }
        },
        always: function (e, data) {
            $(this).removeClass('fileupload-processing');
        },
        completed: function (e, data) {
            var hiddenImageIdInput = $('#'+imageId);
            if(maxNumberOfFiles > 1){ //multi files upload
                var existedId = hiddenImageIdInput.val();
                if (existedId){
                    hiddenImageIdInput.val(existedId+","+data.result.files[0].imageId);
                }else{
                    hiddenImageIdInput.val(data.result.files[0].imageId);
                }
            }else{ //single file upload
                hiddenImageIdInput.val(data.result.files[0].imageId);
            }
        },
        destroyed: function (e, data) {
            var removedId = data.id;
            if (removedId){
                var hiddenImageIdInput = $('#'+imageId);
                if(maxNumberOfFiles > 1){
                    var imageIds = hiddenImageIdInput.val();
                    var idArr = imageIds.split(",");
                    var remainingIdArr = idArr.filter(isNotRemoved);
                    if(remainingIdArr.length > 1){
                        hiddenImageIdInput.val(remainingIdArr.join(","));
                    }else if(remainingIdArr.length ==1){
                        hiddenImageIdInput.val(remainingIdArr[0]);
                    }else{
                        hiddenImageIdInput.val("");
                    }

                    function isNotRemoved(id){
                        return id != removedId;
                    }
                }else{
                    hiddenImageIdInput.val("");
                }
            }
        }
    });
}

function validateForm(){
    // return true;
    return $("#matchupForm").valid();
}
