$(document).ready(function () {
    $.validator.addMethod("namecheck", function (value) {
        return /^[A-Za-z0-9\-_.]*$/.test(value)
    });
    $.validator.addMethod("pwcheck", function (value) {
        return /^[A-Za-z0-9\d=!\-@._]*$/.test(value) // consists of only these
            && /[!\-@._]/.test(value) // has a sepecial letter
            && /[a-z]/.test(value) // has a lowercase letter
            && /[A-Z]/.test(value) // has a uppercase letter
            && /\d/.test(value) // has a digit
    });

    $("#username").inputmask({
        mask: "S{3,32}",
        greedy: false,
        definitions: {
            "S": {
                validator: "[A-Za-z0-9-_.]",
                cardinality: 1,
                placeholder: '',
                greedy: false
            }
        }
    });
    var contextPath = $('body').attr('contextPath');
    function rsa() {
        var publicKey;
        var pass = $("#password");
        $.ajaxSetup({
            async: false
        });

        $.get(contextPath+"/login/publicKey", function (data) {
            publicKey = data;
        });

        var encrypt = new JSEncrypt();
        encrypt.setPublicKey(publicKey);
        var epass = encrypt.encrypt(pass.val());
        pass.val(epass);
    }

    $("#command").validate({
        submitHandler: function (form) {
            rsa();
            form.submit();
        },
        highlight: function (element) {
            $(element).closest('.form-group').addClass('has-error');
        },
        unhighlight: function (element) {
            $(element).closest('.form-group').removeClass('has-error');
        },
        rules: {
            j_username: {
                required: true,
                namecheck: true,
                minlength: 3,
                maxlength: 32
            },
            j_password: {
                required: true,
                pwcheck: true,
                minlength: 6,
                maxlength: 16
            }
        },
        messages: {
            j_username: {
                required: "请输入用户名",
                namecheck: "用户名只能是字母、数字和特殊字符-、_和.",
                minlength: "用户名至少3位",
                maxlength: "用户名最多32位"
            },
            j_password: {
                required: "请输入密码",
                pwcheck: "密码包含数字、字母和特殊符号!、-、@、.和_，且包含至少一个数字，一个大写字母、一个小写字母和一个特殊符号",
                minlength: "密码至少6位",
                maxlength: "密码最多16位"
            }
        }
    });

});
